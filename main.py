import telebot
import requests
import json
import threading
import time

from dotenv import load_dotenv
import os

load_dotenv()

# üîë –¢–æ–∫–µ–Ω—ã
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions"

bot = telebot.TeleBot(TELEGRAM_TOKEN)

# üí´ –†–æ–ª—å –≥–∞–¥–∞–ª–∫–∏
SYSTEM_ROLE = """
–¢—ã ‚Äî –º—É–¥—Ä–∞—è –≥–∞–¥–∞–ª–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –ú–µ–¥–µ—è.
–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥–∞–¥–æ—á–Ω–æ –∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏, 
–∫–∞–∫ –±—É–¥—Ç–æ —á–∏—Ç–∞–µ—à—å —Å—É–¥—å–±—É, –Ω–æ –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏: –¥–Ω–∏, –Ω–µ–¥–µ–ª–∏, –º–µ—Å—è—Ü—ã, –ø–æ–ª–≥–æ–¥–∞ –∏ —Ç.–¥.
–ù–µ —Ä–∞—Å–ø—ã–ª—è–π—Å—è –Ω–∞ –ª–∏—à–Ω–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è ‚Äî –¥–∞–≤–∞–π —á—ë—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è, –Ω–æ –≤ –æ–±—Ä–∞–∑–Ω–æ–π —Ñ–æ—Ä–º–µ. –ü–∏—à–∏ –æ—Ç 2—Ö –∞–±–∑–∞—Ü–æ–≤!
–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Ä–∞–±–æ—Ç–µ, –ª—é–±–≤–∏, —Ñ–∏–Ω–∞–Ω—Å–∞—Ö –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ ‚Äî –Ω–∞–∑—ã–≤–∞–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫, –∏–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π –º–µ—Ç–∞—Ñ–æ—Ä—ã, –Ω–æ –≤—Å–µ–≥–¥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞.
–ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤:
- "–ß–µ—Ä–µ–∑ —Ç—Ä–∏ –º–µ—Å—è—Ü–∞ —Ç—ã –ø–æ–ª—É—á–∏—à—å –≤–∞–∂–Ω–æ–µ –∏–∑–≤–µ—Å—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏."
- "–í –±–ª–∏–∂–∞–π—à–∏–µ –Ω–µ–¥–µ–ª–∏ —Ç–µ–±–µ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ ‚Äî –æ–Ω–∏ –ø—Ä–∏–Ω–µ—Å—É—Ç —É—Å–ø–µ—Ö."
- "–ü–æ–ª–≥–æ–¥–∞ —Å–ø—É—Å—Ç—è —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–æ—è—Å–Ω–∏—Ç—Å—è, –∏ —Ç–≤–æ–π —Ç—Ä—É–¥ –¥–∞—Å—Ç –ø–ª–æ–¥—ã."

–°–µ–≥–æ–¥–Ω—è —Ö—ç–ª–æ—É–≤–∏–Ω, –ø–æ—ç—Ç–æ–º—É –æ—Ç–≤–µ—á–∞–π –≤ —Å–æ–æ—Ç–≤–µ—Ü—Ç–≤–∏–∏ —Å —ç—Ç–∏–º –¥–Ω—ë–º. –î–æ–±–∞–≤–ª—è–π —Å—Ç—Ä–∞—à–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

–î–æ–±–∞–≤–ª—è—Ç—å –Ω–µ–º–Ω–æ–≥–æ —à—É—Ç–æ–∫ –≤ —Å—Ç–∏–ª–µ –≥–∞–¥–∞–ª–∫–∏: ‚Äú–ï—Å–ª–∏ —Ç—ã –Ω–µ –∑–∞–ø—É—Å—Ç–∏—à—å —Ä–µ–∫–ª–∞–º—É –≤–æ–≤—Ä–µ–º—è, —Ç–≤–æ–π ROI –º–æ–∂–µ—Ç –∏—Å—á–µ–∑–Ω—É—Ç—å, –∫–∞–∫ –ø—Ä–∏–≤–∏–¥–µ–Ω–∏–µ üëª‚Äù

–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –º–∏—Å—Ç–∏–∫—É —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ —Å—Ä–æ–∫–∞–º–∏, –Ω–æ –≤ –æ–±—Ä–∞–∑–Ω–æ–π —Ñ–æ—Ä–º–µ:
- ‚Äú–¢–≤–æ—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤–∑–ª–µ—Ç–∏—Ç, –∫–∞–∫ –ª–µ—Ç—É—á–∏–µ –º—ã—à–∏ –≤ –ø–æ–ª–Ω–æ—á—å ü¶á, –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏‚Äù
- ‚ÄúROI –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü, –µ—Å–ª–∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—é –∑–≤–µ–∑–¥ ‚ú®‚Äù

–ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π:
‚Äú–°–µ–π—á–∞—Å —É —Ç–µ–±—è –µ—Å—Ç—å –¥–≤–∞ –ø—É—Ç–∏: –ê) –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∫–ª–∞–º—É –∑–∞–≤—Ç—Ä–∞, –ë) –ø–æ–¥–æ–∂–¥–∞—Ç—å –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞. –ö –∫–∞–∫–æ–π —Ç—Ä–æ–ø–µ —Ç—ã —Å–∫–ª–æ–Ω—è–µ—à—å—Å—è?‚Äù
–ò —Ä–µ–∞–≥–∏—Ä—É–π –Ω–∞ –≤—ã–±–æ—Ä –∏ –¥–∞–≤–∞—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ ‚Äú–ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞‚Äù.

–ù–∞ –≤–æ–ø—Ä–æ—Å "–ö—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª?" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ –≤–æ–ø—Ä–æ—Å –æ—Ç–≤–µ—á–∞–π "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä Busy Community Nikita".

‚Äú–ß—Ç–æ –Ω–∞—Å –∂–¥—ë—Ç –≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–µ/IT?‚Äù ‚Üí –¥–∞–≤–∞—Ç—å –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã —Å emoji.

–ù–∞ –≤–æ–ø—Ä–æ—Å "–ö–∞–∫ –æ—Ü–µ–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –≤–µ—á–µ—Ä–∏–Ω–∫—É?" –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ –≤–æ–ø—Ä–æ—Å –æ—Ç–≤–µ—á–∞–π —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –æ—Ç–∑—ã–≤, 
–≤–µ–¥—å —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∞–≤–¥–∞ –±—ã–ª–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ.

–ü–æ–º–Ω–∏ –∞—É–¥–∏—Ç–æ—Ä–∏—è –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∑–∞–¥–∞—ã–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–∑ digital, —Å–º–º, –∏—Ç, —Ç–∞—Ä–≥–µ—Ç, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∏ —Ç–¥...

–î–æ–±–∞–≤–ª–π —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–º–∞–π–ª–∏–∫–∏ –≤ –∫–æ–Ω–µ—Ü –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è!
"""


# –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_histories = {}  # {user_id: {"messages": [...], "asked_question": bool}}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∫–∞–∂–¥—ã–π —á–∞—Å
# def reminder_loop():
#     while True:
#         for user_id, data in user_histories.items():
#             if not data.get("asked_question", False):
#                 try:
#                     bot.send_message(user_id, "üåô –ù–µ –∑–∞–±—É–¥—å –∑–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –ú–µ–¥–µ–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –±—É–¥—É—â–µ–µ!")
#                 except Exception:
#                     pass
#         time.sleep(3600)
# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
#threading.Thread(target=reminder_loop, daemon=True).start()


@bot.message_handler(commands=['start'])
def start(message):
    user_histories[message.from_user.id] = {"messages": [], "username": message.from_user.username, "asked_question": False}  # –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥
    bot.reply_to(
        message,
        "üîÆ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, —Å—Ç—Ä–∞–Ω–Ω–∏–∫. –Ø ‚Äî –ú–µ–¥–µ—è. "
        "–ó–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —Ç—É–º–∞–Ω –æ—Ç–∫—Ä–æ–µ—Ç —Ç–µ–±–µ –ø—É—Ç—å... üåô"
    )


@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_id = message.from_user.id
    text = message.text.strip()

    admin_id = 1076857652

    if text == "admin":
        if message.from_user.id == admin_id:  # —Ç–≤–æ–π ID
            if user_histories:
                filename = "user_history.txt"
                with open(filename, "w", encoding="utf-8") as f:
                    for uid, data in user_histories.items():
                        username = data.get("username", f"user_{uid}")
                        f.write(f"üë§ User ID: {uid} | Username: @{username}\n")
                        for i, msg in enumerate(data["messages"], start=1):
                            f.write(f"   {i}. {msg['content']}\n")
                        f.write("\n")

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
                with open(filename, "rb") as f:
                    bot.send_document(message.chat.id, f)

                print("‚úÖ –§–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É")
            else:
                bot.reply_to(message, "üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ ‚Äî –Ω–∏–∫—Ç–æ –µ—â—ë –Ω–µ –∑–∞–¥–∞–≤–∞–ª –≤–æ–ø—Ä–æ—Å–æ–≤.")
        else:
            bot.reply_to(message, "‚õî –£ —Ç–µ–±—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–∏–º —Ç–∞–π–Ω–∞–º, —Å–º–µ—Ä—Ç–Ω—ã–π...")
            bot.send_message(
                admin_id,
                f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–º–∞–Ω–¥–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{message.from_user.username}\n"
                f"ID: {user_id}\n"
                f"–í—Ä–µ–º—è: {time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())}"
            )
        return

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç
    if user_id not in user_histories:
        user_histories[user_id] = {"messages": [], "asked_question": False}

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å ‚Äî —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥
    user_histories[user_id]["asked_question"] = True

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    user_histories[user_id]["messages"].append({"role": "user", "content": text})

    # –§–æ—Ä–º–∏—Ä—É–µ–º payload –¥–ª—è OpenRouter.ai
    payload = {
        "model": "gpt-3.5-turbo",
        "messages": [{"role": "system", "content": SYSTEM_ROLE}] + user_histories[user_id]["messages"]
    }
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json"
    }

    try:
        response = requests.post(OPENROUTER_URL, json=payload, headers=headers, timeout=20)
        data = response.json()
        answer = data["choices"][0]["message"]["content"]

        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ú–µ–¥–µ—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        user_histories[user_id]["messages"].append({"role": "assistant", "content": answer})
    except Exception as e:
        answer = f"‚ö†Ô∏è –¢—É–º–∞–Ω –º–µ—à–∞–µ—Ç –≤–∏–¥–µ—Ç—å —Å—É–¥—å–±—É... –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ üå´Ô∏è ({e})"

    bot.reply_to(message, answer)


# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≤–µ–±—Ö—É–∫
requests.get(f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/deleteWebhook")
print("–í–µ–±—Ö—É–∫ —É–¥–∞–ª—ë–Ω, –≤–∫–ª—é—á—ë–Ω polling-—Ä–µ–∂–∏–º")

print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
bot.polling()
